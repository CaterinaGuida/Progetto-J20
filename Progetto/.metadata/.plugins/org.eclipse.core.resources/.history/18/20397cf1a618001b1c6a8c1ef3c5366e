/* Oggetto di accesso al database per la memorizzazione dell'attivazione di un titolo di viaggio */

package dao;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;

public class DaoActiver {
	
	private DaoFactory Dao;
	private SimpleDateFormat str=new SimpleDateFormat("dd/MM/yyyy HH:mm");

	public DaoActiver(DaoFactory Dao){
		super();
		this.Dao=Dao;
		
	}

	public String[] activate(String codice) throws ParseException {
		
		Connection con;
		try {
			con = Dao.getConnection();
			Statement st= con.createStatement();
			String query=String.format("select count(*) as number from titoli where codice='%s'",codice); 
			ResultSet result= st.executeQuery(query);
			int number=0;
			while(result.next()) {
				number= result.getInt("number");
			}
			if (number==0) {
				String output[]= new String[2];
				output[0]= "Titolo non esistente";
				return output;
			}
			else{
				
				query=String.format("select * from titoli where codice='%s'",codice);
				ResultSet  res= st.executeQuery(query);
				String tipo= "";
				int numviaggi=0;
				while(res.next()) {
					tipo= res.getString("tipo");
					if(tipo.equals("cumulativo")){
						numviaggi= res.getInt("numviaggi");
					}
				}
				
				
				if(tipo.equals("singolo")) {
					
					query=String.format("select count(*) as number from attivati where id='%s'",codice);
					ResultSet risultati= st.executeQuery(query);
					int numero=0;
					while(risultati.next()) {
						numero= risultati.getInt("number");
					}
					if (numero==0) {
						
						Date date= new Date();
						date.setHours(date.getHours()+1);
						query=String.format("insert into attivati(id,expirarionDate,numviaggi_mancanti) values('%s','%s',0)",codice,str.format(date));
						st.executeUpdate(query);
						String output[]= new String[3];
						output[0]= "Titolo Attivato";
						output[1]= "Biglietto viaggio singolo";
						output[2]= str.format(date);
						return output;
					}
					else{
						query=String.format("select *  from attivati where id='%s'",codice);
						risultati= st.executeQuery(query);
						Date date=null;
						while(risultati.next()) {
							date= str.parse(risultati.getString("expirarionDate"));
							if(date.before(new Date())) {
								System.out.println("Biglietto scaduto");
								String output[]= new String[3];
								output[0]= "Titolo Scaduto";
								output[1]= "Biglietto viaggio singolo";
								output[2]= str.format(date);
								return output;
							}
							else {
								System.out.println("Biglietto valido");
								String output[]= new String[3];
								output[0]= "Titolo Attivato";
								output[1]= "Biglietto viaggio singolo";
								output[2]= str.format(date);
								return output;
							}
							
						}
						
						
					}
				}
				
				
				else if(tipo.equals("cumulativo")) {
					
					query=String.format("select count(*) as number from attivati where id='%s'",codice);
					ResultSet risultati= st.executeQuery(query);
					int numviaggi_mancanti=0;
					int numero=0;
					while(risultati.next()) {
						numero= risultati.getInt("number");
						
					}
					if (numero==0) {
						
						Date date= new Date();
						date.setHours(date.getHours()+1);
						query=String.format("insert into attivati(id,expirarionDate,numviaggi_mancanti) values('%s','%s','%d')",codice,str.format(date),numviaggi-1);
						st.executeUpdate(query);
						String output[]= new String[4];
						output[0]= "Titolo cumulativo Attivato";
						output[1]= "Biglietto cumulativo";
						output[2]= str.format(date);
						output[3]= ""+(numviaggi-1);
						return output;
					}
					else {
						System.out.println("biglietto cum makjd attivato ");
						query=String.format("select *  from attivati where id='%s'",codice);
						risultati= st.executeQuery(query);
						Date date=null;
						while(risultati.next()) {
							date= str.parse(risultati.getString("expirarionDate"));
							numviaggi_mancanti= risultati.getInt("numviaggi_mancanti");
							if(date.before(new Date()) && numviaggi_mancanti==0) {
								
								String output[]= new String[3];
								output[0]= "Titolo Scaduto";
								output[1]= "Biglietto cumulativo";
								output[2]= str.format(date);
								return output;
							}
							else if(date.before(new Date()) && numviaggi_mancanti>0) {
								query=String.format("delete  from attivati where id='%s'",codice);
								st.executeUpdate(query);
								date= new Date();
								date.setHours(date.getHours()+1);
								query=String.format("insert into attivati(id,expirarionDate,numviaggi_mancanti) values('%s','%s','%d')",codice,str.format(date),numviaggi_mancanti-1);
								st.executeUpdate(query);
								String output[]= new String[4];
								output[0]= "Titolo cumulativo Attivato";
								output[1]= "Biglietto cumulativo";
								output[2]= str.format(date);
								output[3]= ""+(numviaggi_mancanti-1);
								return output;
								
							}
							else if(date.after(new Date())) {
								String output[]= new String[4];
								output[0]= "Titolo cumulativo Attivato";
								output[1]= "Biglietto cumulativo";
								output[2]= str.format(date);
								output[3]= ""+(numviaggi_mancanti);
								return output;
								
							}
						}
					}
					
				}
				
				
				
				else if(tipo.equals("abbonamento")) {
					
					query=String.format("select * from abbonamento where id='%s'",codice);
					ResultSet risultati= st.executeQuery(query);
					Date date=null;
					while(risultati.next()) {
						date= str.parse(risultati.getString("expirarionDate"));
						if(date.before(new Date())) {
							String output[]= new String[3];
							output[0]= "Titolo Scaduto";
							output[1]= "Abbonamento";
							output[2]= str.format(date);
							return output;
						}
						else {
							
							String output[]= new String[3];
							output[0]= "Titolo valido";
							output[1]= "Abbonamento";
							output[2]= str.format(date);
							return output;
						}
					}
				}
				
			}
			return null;
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return null;
		
		
	}
}
